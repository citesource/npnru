<!DOCTYPE html>
<html>

<head>
    <meta charset="utf-8" />
    <title>NPNRU</title>
    <meta name="viewport" content="initial-scale=1,maximum-scale=1,user-scalable=no" />
    <link rel="shortcut icon" type="image/png" href="img/logo_anru-01.png"/>
	<link href="//maxcdn.bootstrapcdn.com/font-awesome/4.1.0/css/font-awesome.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.3.3/dist/leaflet.css" />
    <!--[if lte IE 8]><link rel="stylesheet" href="//cdn.leafletjs.com/leaflet-0.7.2/leaflet.ie.css" /><![endif]-->

    <link rel="stylesheet" href="src/leaflet-sidebar.css" />

	<style>

		body {
            padding: 0;
            margin: 0;
        }

        html, body, #mapid {
            height: 100%;
            font: 10pt "Helvetica Neue", Arial, Helvetica, sans-serif;
        }

        .lorem {
            font-style: italic;
            color: #1d1d1b;
			em:1.2;
        }
		
		.presentation {
			display: block;
		}
		
		#popup {
			display: none;
		}
		
		h1{
			em:2;
			text-transform: uppercase;
			color:#004494;
			text-align:center;
		}
	
		h2{
			em:1.8;
			color: #1d1d1b;
		}


</style>
</head>

<body>
    <div id="sidebar" class="sidebar collapsed">
        <!-- Nav tabs -->
        <div class="sidebar-tabs">
            <ul role="tablist">
                <li><a href="#home" role="tab" id="logo_acv"><i class="fa"><img src="img/logo_anru-01.png" style="width:30px;padding:5px"  /></i></a></li>
                <li><a href="https://www.anru.fr/fre/Programmes/Nouveau-Programme-National-de-Renouvellement-Urbain" role="tab" target="_blank" title="Site officiel"><i class="fa fa-home"></i></a></li>
            </ul>
        </div>

        <!-- Tab panes -->
        <div class="sidebar-content">
            <div class="sidebar-pane" id="home">
                <h1 class="sidebar-header">
                    NPNRU
                    <span class="sidebar-close" id="close"><i class="fa fa-caret-left"></i></span>
                </h1>
				
				<div class="presentation" id="defaut">
					<h1>Nouveau Programme National de Renouvellement Urbain</h1>
					<h2>2014-2024 : 5 milliards pour les habitants des quartiers les plus en difficulté</h2>
					<div id="bouton-int-nat"><img src="img/pictos_national_off.png" style="width:17px; padding-right:5px; vertical-align:middle;"  />Quartier d'intérêt <strong>national</strong> </div>
					<div id="bouton-int-reg"><img src="img/pictos_regional_off.png" style="width:17px; padding-right:5px; vertical-align:middle;"  />Quartier d'intérêt <strong>régional</strong> </div>
					<h2>Les conventions opérationnelles</h2>
					<p>Les conventions seront signées par les intercommunalités tout le long des années 2017 et 2018</p>
					<div id="bouton-int-conv"><img src="img/pictos_conventions.png" style="width:17px; padding-right:5px; vertical-align:middle;"  />Avancement des signatures au 9 août 2018</div>
					<br/>
					<p><i>Source : <a href="https://www.anru.fr/fre/Programmes/Nouveau-Programme-National-de-Renouvellement-Urbain" style="text-decoration:none;" target="_blanck ">ANRU 2018</a></i></p>
				</div>

				<div id="popup">
					<h1 id="libgeo"></h1>
					<p id="interet" ></p> 
					<p id="region" class="lorem"></p> 
					
				</div>
				
            </div>

            <div class="sidebar-pane" id="profile">
                <h1 class="sidebar-header">Profile<span class="sidebar-close"><i class="fa fa-caret-left"></i></span></h1>
            </div>

        </div>
    </div>


	<div id="mapid" class="sidebar-map"></div>
	
     <script src="https://unpkg.com/leaflet@1.3.3/dist/leaflet.js"></script>
    <script src="https://turbo87.github.io/sidebar-v2/js/leaflet-sidebar.js"></script>
	<script type="text/javascript" src="data/masque.js"></script>
	<script type="text/javascript" src="data/departements.js"></script>
	<script type="text/javascript" src="data/regions.js"></script>
	<script type="text/javascript" src="data/epci2018.js"></script>
	<script type="text/javascript" src="data/npnru_p.js"></script>
	<script type="text/javascript" src="data/npnru_s.js"></script>
	
	
    <script>
		
			
		// Création de la carte
		var map = L.map('mapid', {maxZoom:11, minZoom:6 
		})
		.setView([46.5, 2], 6);
		map.zoomControl.setPosition('topright');
		
		//Définition des pictos
		var national_off = new L.Icon({iconUrl: 'img/pictos_ptt_national_off.png', iconSize: [10,10], iconAnchor:[5,5]}),
			regional_off = new L.Icon({iconUrl: 'img/pictos_ptt_regional_off.png', iconSize: [10,10], iconAnchor:[5,5]}),
			national_on = new L.Icon({iconUrl: 'img/pictos_ptt_national_on.png', iconSize: [20,20], iconAnchor:[10,10]}),
			regional_on = new L.Icon({iconUrl: 'img/pictos_ptt_regional_on.png', iconSize: [20,20], iconAnchor:[10,10]});

		// Choix du fond de carte 
		var GeoportailFrance_parcels = L.tileLayer('https://wxs.ign.fr/{apikey}/geoportail/wmts?REQUEST=GetTile&SERVICE=WMTS&VERSION=1.0.0&STYLE={style}&TILEMATRIXSET=PM&FORMAT={format}&LAYER=CADASTRALPARCELS.PARCELS&TILEMATRIX={z}&TILEROW={y}&TILECOL={x}', {
		apikey: 'choisirgeoportail',
		format: 'image/png',
		style: 'bdparcellaire'
		});
		GeoportailFrance_parcels.addTo(map);

		
		//Ajout des couches du fond de carte
		Cache = L.geoJSON(JS_masque, {color: "#e6f0ff", weight: 0, opacity: 1, fillOpacity: 1}).addTo(map);
		Fond_Regions = L.geoJSON(JS_reg, {weight: 0, opacity: 1, fillOpacity: 1, fillColor:"#9ac3ff"}).addTo(map);
		Contour_Regions = L.geoJSON(JS_reg, {color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0}).addTo(map);
		//Contour_Regions_notGEN = L.geoJSON(JS_reg_notGEN, {color: "#ffffff", weight: 2, opacity: 1, fillOpacity: 0});
		Departements = L.geoJSON(JS_dep, {color: "#ffffff", weight: 1, opacity: 1, fillOpacity: 0}).addTo(map);
		//Departements_notGEN = L.geoJSON(JS_dep_notGEN, {color: "#ffffff", weight: 1, opacity: 1, fillOpacity: 0});
		//Communes = L.geoJSON(JS_com2018, {color: "#ffffff", weight: 0.5, opacity: 0.7, fillOpacity: 0});
		EPCI = L.geoJSON(JS_epci2018, {
			style: {fillColor: "red", weight: 0, opacity: 1, fillOpacity: 1},
			filter: function(feature, layer) {
                return feature.properties.codgeo == "200072130" || feature.properties.codgeo == "246200729" || feature.properties.codgeo == "245901160" || feature.properties.codgeo == "200054781" || feature.properties.codgeo == "200027183" || feature.properties.codgeo == "200046977";
				},
			onEachFeature: onEachFeature
			}).addTo(map);
		NPNRU_S = L.geoJSON(JS_npnru_S, {fillColor: "#ffffff", weight: 0, opacity: 1, fillOpacity: 1}).addTo(map);
		
		function onEachFeature(feature,layer) {
			layer.on ({
			click : function(e){
				if (document.getElementById('sidebar').classList.contains('collapsed')){
					sidebar.open('home');
					if (map.getZoom() < 8) {map.setView([46.5, -3], 6);}
					}
				L.DomEvent.stopPropagation(e);
				document.getElementById('popup').style.display = "block";
				document.getElementById('defaut').style.display = "none";
				document.getElementById('libgeo').innerHTML = feature.properties.libgeo;
				document.getElementById('interet').innerHTML = "Convention signée";
				}
			});
		}
		
		//Modification des couches du fond de carte avec le zoom sur la carte
		/*map.on('zoomend', function zoomendEvent() {
			var zoom = map.getZoom();
			if (zoom > 8 && map.hasLayer(Contour_Regions)) {
				map.removeLayer(Contour_Regions);
				map.removeLayer(Departements);
				map.addLayer(Departements_notGEN);
				map.addLayer(Contour_Regions_notGEN);
				}
			else if (zoom < 9 && map.hasLayer(Contour_Regions_notGEN)) {
				map.removeLayer(Departements_notGEN);
				map.removeLayer(Contour_Regions_notGEN);
				map.addLayer(Contour_Regions);
				map.addLayer(Departements);
				}
		})*/
		
		// Action au clic sur un marker
		var test;
		function infos(e) {
			if (document.getElementById('sidebar').classList.contains('collapsed')){
				
				sidebar.open('home');
				if (map.getZoom() < 8) {map.setView([46.5, -3], 6);}
				}
			if(test){
				//console.log(test.feature.properties.INTERET);
				if (test.feature.properties.INTERET == "national") {test.setIcon(national_off);}
				else if (test.feature.properties.INTERET == "regional"){test.setIcon(regional_off);};
				}
				test = e.target;
				if (test.feature.properties.INTERET == "national") {test.setIcon(national_on)}
				else if (test.feature.properties.INTERET == "regional"){test.setIcon(regional_on)};
				document.getElementById('popup').style.display = "block";
				document.getElementById('defaut').style.display = "none";
				document.getElementById('libgeo').innerHTML = e.target.feature.properties.NOMQP;
				document.getElementById('interet').innerHTML = "Quartier d'intérêt "+e.target.feature.properties.INTERET;
				document.getElementById('region').innerHTML = "Quartier de la commune <strong>"+e.target.feature.properties.COMMUNE_QP+"</strong>, région <strong>"+e.target.feature.properties.NREG+"</strong>.";
		}
		
		//Création de la sidebar
		var sidebar = L.control.sidebar('sidebar').addTo(map);
		
		//Ajout des couches NPNRU
		NPNRU_nat = L.geoJSON(JS_npnru_P, {
				pointToLayer: function(feature, latlng) {
					return L.marker(latlng,{icon:national_off}).on('click', function(e) { infos(e);})
				},
				filter : function(feature, layer) {
                return feature.properties.INTERET == "national";
				}
				//onEachFeature : function(feature, layer) {
				//	layer.bindTooltip(feature.properties.COMMUNE_QP, {closeButton: false, offset: L.point(0, 0)});
				//	}
		}).addTo(map)
		
		NPNRU_reg = L.geoJSON(JS_npnru_P, {
				pointToLayer: function(feature, latlng) {
					return L.marker(latlng,{icon:regional_off}).on('click', function(e) { infos(e);})
					},
				filter : function(feature, layer) {
					return feature.properties.INTERET == "regional";
					}
				//onEachFeature : function(feature, layer) {
				//	layer.bindTooltip(feature.properties.COMMUNE_QP, {closeButton: false, offset: L.point(0, 0)});
				//	}
		}).addTo(map)
				
		
		//Events au clic sur la carte
		map.on('click', function(e) {   
			document.getElementById('popup').style.display = "none";
			document.getElementById('defaut').style.display = "block";   
			map.addLayer(NPNRU_reg);
			map.addLayer(NPNRU_nat);
		});
		
		//Carte qui bouge à l'ouverture de la popup
		document.getElementById("logo_acv").addEventListener("click", function(){
		if(map.getZoom() < 8){
		if (document.getElementById('sidebar').classList.contains('collapsed')) {
		map.panTo([46.5, 2],{duration: 0.5 });}
		else {map.panTo([46.5, -3],{duration: 0.5 });}
		}
		});

		document.getElementById("close").addEventListener("click", function(){
		if(map.getZoom() < 8){
		if (document.getElementById('sidebar').classList.contains('collapsed') && map.getZoom() < 8) {
		map.panTo([46.5, 2],{duration: 0.5 });}
		else {map.panTo([46.5, -3],{duration: 0.5 });}
		}
		}); 

		document.getElementById("bouton-int-nat").addEventListener("click", function(){
			if (map.hasLayer(NPNRU_reg)) {map.removeLayer(NPNRU_reg)};
			if (map.hasLayer(NPNRU_nat)==false) {map.addLayer(NPNRU_nat);}
		}); 
		
		document.getElementById("bouton-int-reg").addEventListener("click", function(){
			if (map.hasLayer(NPNRU_nat)) {map.removeLayer(NPNRU_nat)};
			if (map.hasLayer(NPNRU_reg)==false) {map.addLayer(NPNRU_reg);}
		}); 
		
		document.getElementById("bouton-int-conv").addEventListener("click", function(){
			if (map.hasLayer(NPNRU_nat)) {map.removeLayer(NPNRU_nat)};
			if (map.hasLayer(NPNRU_reg)) {map.removeLayer(NPNRU_reg);}
		});
		
		

   </script>
	
</body>



</html>
